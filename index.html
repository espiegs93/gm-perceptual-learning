<!doctype html>
<meta charset='utf-8'>
<title>GM Experiment</title>
<script src="scripts/jquery-1.11.1.min.js"></script>
<!-- Load D3 for GM -->
<script src="libs/d3/d3.min.js"></script>
<!-- Load Grasping Math -->
<script src="libs/graspablemath.js"></script>
<!-- Load the jspsych library and plugins -->
<script src="stimuli/scrambler.js"></script>
<script src="scripts/jspsych.js"></script>
<script src="scripts/plugins/jspsych-text.js"></script>
<script src="scripts/plugins/jspsych-html.js"></script>
<script src="scripts/plugins/jspsych-gm-tutorial.js"></script>
<script src="scripts/plugins/jspsych-gm-solve-eq.js"></script>
<script src="scripts/plugins/jspsych-gm-multiple-choice.js"></script>
<!-- Load the stylesheet -->
<link href="css/jspsych.css" type="text/css" rel="stylesheet"></link>
<link rel="stylesheet" href="libs/fonts/fonts.css"/>
<link rel="stylesheet" href="css/main.css"/>
<link rel="stylesheet" href="css/bootstrap.css"/>
<link rel="stylesheet" href="css/bootstrap-theme.css"/>
</head>

<div id="jspsych_target"></div>

<script>

test_mode = true;
subject_id = gmath.uid();

gmath.AlgebraView.defaultOptions.inactive_color = gmath.AlgebraView.defaultOptions.color;

var welcomeMessage = '<div id="welcome"><p>Welcome to the experiment. Press enter to begin.</p></div>';

var welcomeBlock = { type: 'text', text: [welcomeMessage] };

var tutorialBlock = { type: 'gm-tutorial'
                     ,problems: [{expression: 'a+b+c'
                                 ,correctAction: 'commute terms'}
                                ,{expression: 'x+2=0'
                                 ,correctAction: 'invert terms across equation'}
                                ,{expression: '2x+2x'
                                 ,correctAction: 'direct factor'}
                                ,{expression: '(x+y)*z'
                                 ,correctAction: 'distribute'}
                                ,{expression: 'x/(z+1)=y'
                                 ,correctAction: 'alt-select'}]}

function startExperiment(pretestBlock, posttestBlock, testingBlock) {
  jsPsych.init({
    display_element: $('#jspsych_target')
  , experiment_structure: [
      welcomeBlock
    , {type: "html", title: "Instructions", timing_post_trial: 500, pages: [
        { url: "html-templates/pre-instructions.html"
        , cont_btn: "start"
        , force_refresh: true
        }
      ]}
    , pretestBlock
    , {type: "html", title: "Tutorial", timing_post_trial: 500, pages: [
        { url: "html-templates/tutorial-instructions.html"
        , cont_btn: "start"
        , force_refresh: true
        }
      ]}
    , tutorialBlock
    , {type: "html", title: "Instructions", timing_post_trial: 500, pages: [
        { url: "html-templates/test-instructions.html"
        , cont_btn: "start"
        , force_refresh: true
        }
      ]}
    , testingBlock
    , {type: "html", title: "Instructions", timing_post_trial: 500, pages: [
        { url: "html-templates/post-instructions.html"
        , cont_btn: "start"
        , force_refresh: true
        }
      ]}
    , posttestBlock
    , {type: "html", title: "Instructions", timing_post_trial: 500, pages: [
        { url: "html-templates/finished.html"
        , force_refresh: true
        }
      ]}
  ]
  , on_finish: function(block) {
      //jsPsych.dataAPI.displayData('json');
      //jsPsych.dataAPI.localSave('data.json', 'json')
    }
  });
}

function pre_post_saver(idx, trial, finished_callback) {
  console.log(trial, trial.stage);
  var saveData = {
    // exp_id: experiment_id
    stage: trial.stage
  , trial_idx: idx
  , task_id: trial.task_id
  , task: trial.eq
  , correct_answer: trial.sol
  , recorded_time_to_action: trial.time_to_action
  , recorded_time_to_submit: trial.time_to_submit
  , recorded_answer: trial.userInput
  , recorded_accuracy: trial.accuracy
  }
  if (test_mode) {
    console.log('would transmit ', JSON.stringify([saveData]));
    finished_callback();
  } else {
    submitToServer(saveData, finished_callback);
  }
}

function save_main_trial(idx, trial, finished_callback) {
  var saveData = {
    // exp_id: experiment_id
    stage: 'main'
  , trial_idx: idx
  , cond: 'interactive'
  , task: trial.solution
  , task_id: trial.task_id
  , optionA: trial.A
  , optionB: trial.B
  , optionC: trial.C
  , optionD: trial.D
  , correct_answer: trial.correctAnswer
  , recorded_time_to_action: trial.time_to_action
  , recorded_time_to_submit: trial.time_to_submit
  , recorded_action_result: trial.userResult
  , recorded_accuracy: trial.accuracy
  , recorded_action_count: trial.userActionCount
  , recorded_answer: trial.userChoice
  };
  if (test_mode) {
    console.log('would transmit ', JSON.stringify([saveData]));
    finished_callback();
  }
  else submitToServer(saveData, finished_callback);
}

function submitToServer(data, callback) {
  $.ajax({
    type: 'post',
    cache: false,
    url: 'db_submit.php',
    data: { json: JSON.stringify(Array.isArray(data) ? data : [data])
          , subject_id: subject_id },
    success: callback
  });
}

function parsePrePostCSV(callback) {
  d3.csv('stimuli/pre-post.csv')
      .row(function(d) {return {problemBase:d.problemBase
                               ,solutionBase:d.solutionBase
                               ,problem1:d.problem1
                               ,solution1:d.solution1
                               ,problem2:d.problem2
                               ,solution2:d.solution2}})
      .get(callback);
              // .get(function(err, rows) {console.log(rows)});
}

function createPrePostBlocks(rows) {
  var pretestProblems = []
     ,posttestProblems = [];
  for (var i=0; i<rows.length; i++) {
    var row = rows[i];
    var option1 = {eq:row.problem1, 'var':'x', sol:row.solution1}
       ,option2 = {eq:row.problem2, 'var':'x', sol:row.solution2};
    if (Math.random()>=0.5) {
      pretestProblems.push(option1); posttestProblems.push(option2);
    } else {
      pretestProblems.push(option2); posttestProblems.push(option1);
    }
  }

  var pretestBlock = {
    type: 'gm-solve-eq'
  , timing_post_trial: 500
  , save_trial: pre_post_saver
  , problems: pretestProblems
  , stage: 'pre'
  };

  var posttestBlock = {
    type: 'gm-solve-eq'
  , timing_post_trial: 500
  , save_trial: pre_post_saver
  , problems: posttestProblems
  , stage: 'post'
  };

  return [pretestBlock, posttestBlock];
}

function parseMainCSV(callback) {
  d3.csv('stimuli/main.csv')
      .row(function(d) {return {target:d.target
                               ,correct:d.correctBase
                               ,bad1:d.badBase1
                               ,bad2:d.badBase2
                               ,bad3:d.badBase3}})
      .get(callback);
}

function createMainBlock(rows) {
  problems = [];
  scrambledRows = permutation(rows);
  for (var i=0; i<scrambledRows.length; i++) {
    var row = scrambledRows[i];
    var scrambled = scramble([row.target, row.correct, row.bad1, row.bad2, row.bad3]);
    var problem = {};
    var choices = permutation(scrambled.slice(2));
    var idx = Math.round(Math.random()*3);
    choices.splice(idx, 0, scrambled[1]);
    var letter;
    switch(idx) {
      case 0:
        letter = 'A';
        break;
      case 1:
        letter = 'B';
        break;
      case 2:
        letter = 'C';
        break;
      case 3:
        letter = 'D';
        break;
    }
    problem.solution = scrambled[0];
    problem.A = choices[0];
    problem.B = choices[1];
    problem.C = choices[2];
    problem.D = choices[3];
    problem.correctAnswer = letter;
    problems.push(problem);
  }

  var testingBlock = {
    type: 'gm-multiple-choice'
   ,save_trial: save_main_trial
   ,timing_post_trial: 500
   ,problems: problems
  }

  return testingBlock;
}

parsePrePostCSV(function(err, rows) {
  var blocks = createPrePostBlocks(rows);
  parseMainCSV(function(err, rows) {
    var mainBlock = createMainBlock(rows);
    startExperiment(blocks[0], blocks[1], mainBlock);
  });
});
</script>
